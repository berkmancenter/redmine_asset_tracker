<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: ReservationsController
  
    &mdash; Documentation by YARD 0.8.2.1
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (R)</a> &raquo;
    
    
    <span class="title">ReservationsController</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: ReservationsController
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="PluginController.html" title="PluginController (class)">PluginController</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ApplicationController</li>
          
            <li class="next"><span class='object_link'><a href="PluginController.html" title="PluginController (class)">PluginController</a></span></li>
          
            <li class="next">ReservationsController</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">IceCube</dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">app/controllers/reservations_controller.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Author:</p>
<ul class="author">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>Emmanuel Pastor/Nitish Upreti</p>
</div>
      
    </li>
  
</ul>

</div>






  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#change_status-instance_method" title="#change_status (instance method)">- (Object) <strong>change_status</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Changes the status of a reservation.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create-instance_method" title="#create (instance method)">- (Object) <strong>create</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Creates a Reservation in the DB.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#delete-instance_method" title="#delete (instance method)">- (Object) <strong>delete</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Deletes a Reservation from the DB.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#find_bookable-instance_method" title="#find_bookable (instance method)">- (Object) <strong>find_bookable</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Finds out what type of class a bookable (polymorphic class) is.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#history-instance_method" title="#history (instance method)">- (Reservation) <strong>history</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Displays old reservations.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#index-instance_method" title="#index (instance method)">- (Reservation) <strong>index</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Lists all the Reservations from the DB.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#live_search-instance_method" title="#live_search (instance method)">- (Reservation) <strong>live_search</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Searches reservations via ajax.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#new-instance_method" title="#new (instance method)">- (Reservation) <strong>new</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Creates a new Reservation instance, ready to be written to the DB.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#show_by_bookable-instance_method" title="#show_by_bookable (instance method)">- (Reservation) <strong>show_by_bookable</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Search reservations by the polymorphic bookable class.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#show_notes-instance_method" title="#show_notes (instance method)">- (Reservation) <strong>show_notes</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Displays any notes added to a given reservation.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#sort-instance_method" title="#sort (instance method)">- (Reservation) <strong>sort</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Sorts a resultset of reservations.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_notes-instance_method" title="#update_notes (instance method)">- (Object) <strong>update_notes</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Updates any notes added to a given Reservation.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="PluginController.html" title="PluginController (class)">PluginController</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="PluginController.html#populate_asset_list-instance_method" title="PluginController#populate_asset_list (method)">#populate_asset_list</a></span>, <span class='object_link'><a href="PluginController.html#populate_favourite_list-instance_method" title="PluginController#populate_favourite_list (method)">#populate_favourite_list</a></span></p>

  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="change_status-instance_method">
  
    - (<tt>Object</tt>) <strong>change_status</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Changes the status of a reservation.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'>
<p>Nothing.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


232
233
234
235
236
237
238
239
240
241
242
243</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/reservations_controller.rb', line 232</span>

<span class='kw'>def</span> <span class='id identifier rubyid_change_status'>change_status</span>
  <span class='id identifier rubyid_reservation'>reservation</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_find_by_id'>find_by_id</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:status</span><span class='rbracket'>]</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_IN</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_check_in_date'>check_in_date</span> <span class='op'>=</span> <span class='const'>DateTime</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
    <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='id identifier rubyid_x'>x</span> <span class='op'>==</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_OUT</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_check_out_date'>check_out_date</span> <span class='op'>=</span> <span class='const'>DateTime</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sort'>sort</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="create-instance_method">
  
    - (<tt>Object</tt>) <strong>create</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Creates a Reservation in the DB.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'>
<p>Nothing.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/reservations_controller.rb', line 58</span>

<span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>

  <span class='id identifier rubyid_is_recurring'>is_recurring</span><span class='op'>=</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:is_recurring</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_repeat_count'>repeat_count</span><span class='op'>=</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:repeat_count</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
    
  <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:checkin</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='op'>||</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:checkout</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='kw'>nil</span>
      <span class='ivar'>@error_message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Dates can't be empty</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_in_date'>in_date</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_zone'>zone</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:checkin</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_time'>to_time</span>
  <span class='id identifier rubyid_out_date'>out_date</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_zone'>zone</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:checkout</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_time'>to_time</span>


  <span class='comment'>#Make sure that check-in happens after check-out
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_out_date'>out_date</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_in_date'>in_date</span>
      <span class='ivar'>@error_message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Checkout date can't happen after Checkin</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'>#Make sure both are in the future
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_in_date'>in_date</span> <span class='op'>&lt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>||</span> <span class='id identifier rubyid_out_date'>out_date</span> <span class='op'>&lt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
      <span class='ivar'>@error_message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Dates can't be in the past</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'>#We have a non-recurring reservation request coming up with recurring checkbox unticked
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_is_recurring'>is_recurring</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='kw'>then</span> 

    <span class='comment'>#check collision with non-recurring reservations
</span>    <span class='id identifier rubyid_reservations'>reservations</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bookable_id = :bookable_id AND bookable_type = :bookable_type AND status &lt;&gt; :status AND ((:out_date &gt;= check_out_date AND  :out_date &lt;= check_in_date) OR (:in_date &lt;= check_in_date AND :in_date &gt;= check_out_date) OR (:out_date &lt;= check_in_date AND :in_date &gt;= check_in_date)) AND is_recurring= :is_recurring</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:bookable_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_id</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:bookable_type</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_type</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:status</span> <span class='op'>=&gt;</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_IN</span><span class='comma'>,</span> <span class='symbol'>:out_date</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_out_date'>out_date</span><span class='comma'>,</span> <span class='symbol'>:in_date</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_in_date'>in_date</span><span class='comma'>,</span> <span class='symbol'>:is_recurring</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rparen'>)</span>
    
    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_reservations'>reservations</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='ivar'>@error_message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This Asset has already been reserved for those dates</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span>
    <span class='kw'>end</span>

    <span class='comment'>#Check collisions with recurring reservations which were started prior to this reservation
</span>    <span class='id identifier rubyid_reservations'>reservations</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='symbol'>:all</span><span class='comma'>,</span> <span class='symbol'>:conditions</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bookable_id = ? AND bookable_type = ? AND check_out_date &lt;= ? AND status &lt;&gt; ? AND is_recurring = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_id</span><span class='rbracket'>]</span><span class='comma'>,</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_type</span><span class='rbracket'>]</span><span class='comma'>,</span><span class='id identifier rubyid_in_date'>in_date</span><span class='comma'>,</span><span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_IN</span><span class='comma'>,</span><span class='kw'>true</span><span class='rbracket'>]</span>

    <span class='id identifier rubyid_current_schedule'>current_schedule</span><span class='op'>=</span><span class='const'>Schedule</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_out_date'>out_date</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='symbol'>:duration</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_in_date'>in_date</span> <span class='op'>-</span> <span class='id identifier rubyid_out_date'>out_date</span><span class='rbrace'>}</span><span class='rparen'>)</span>
    <span class='comment'>#A serious bug in ice_cube forces us to add a recurrence rule if we want conflict_with to work, so adding one
</span>    <span class='id identifier rubyid_current_schedule'>current_schedule</span><span class='period'>.</span><span class='id identifier rubyid_add_recurrence_rule'>add_recurrence_rule</span> <span class='const'>Rule</span><span class='period'>.</span><span class='id identifier rubyid_yearly'>yearly</span><span class='lparen'>(</span><span class='int'>5</span><span class='rparen'>)</span> <span class='comment'>#repear every 5 years which is pointless
</span>

    <span class='id identifier rubyid_reservations'>reservations</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span>
      <span class='id identifier rubyid_schedule'>schedule</span><span class='op'>=</span><span class='const'>Schedule</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_out_date'>check_out_date</span><span class='comma'>,</span><span class='lbrace'>{</span> <span class='symbol'>:duration</span> <span class='op'>=&gt;</span><span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_in_date'>check_in_date</span> <span class='op'>-</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_out_date'>check_out_date</span><span class='comma'>,</span> <span class='symbol'>:end_time</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_in_date'>check_in_date</span> <span class='op'>+</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_repeat_count'>repeat_count</span><span class='op'>*</span><span class='const'>IceCube</span><span class='op'>::</span><span class='const'>ONE_WEEK</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_schedule'>schedule</span><span class='period'>.</span><span class='id identifier rubyid_add_recurrence_rule'>add_recurrence_rule</span> <span class='const'>Rule</span><span class='period'>.</span><span class='id identifier rubyid_weekly'>weekly</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_schedule'>schedule</span><span class='period'>.</span><span class='id identifier rubyid_conflicts_with?'>conflicts_with?</span><span class='lparen'>(</span><span class='id identifier rubyid_current_schedule'>current_schedule</span><span class='rparen'>)</span> <span class='kw'>then</span>
        <span class='ivar'>@error_message</span> <span class='op'>=</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This Reservation conflicts with another recurring reservation,Contact the Administrator</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>return</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_reservation'>reservation</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_bookable_type'>bookable_type</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_type</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_bookable_id'>bookable_id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_id</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find_by_id'>find_by_id</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_id</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_check_in_date'>check_in_date</span> <span class='op'>=</span> <span class='id identifier rubyid_in_date'>in_date</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_check_out_date'>check_out_date</span> <span class='op'>=</span> <span class='id identifier rubyid_out_date'>out_date</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_READY</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_notes'>notes</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:notes</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_is_recurring'>is_recurring</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_repeat_count'>repeat_count</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
  <span class='kw'>else</span>


    <span class='kw'>if</span> <span class='id identifier rubyid_repeat_count'>repeat_count</span> <span class='op'>&gt;</span> <span class='int'>52</span> <span class='kw'>then</span>
      <span class='ivar'>@error_message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cannot create a Recurring Reservation which spans for more than a year</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_repeat_count'>repeat_count</span> <span class='op'>&lt;=</span> <span class='int'>1</span> <span class='kw'>then</span>
      <span class='ivar'>@error_message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid Repeat Count Value.</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_current_schedule'>current_schedule</span><span class='op'>=</span><span class='const'>Schedule</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_out_date'>out_date</span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='symbol'>:duration</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_in_date'>in_date</span> <span class='op'>-</span> <span class='id identifier rubyid_out_date'>out_date</span><span class='comma'>,</span> <span class='symbol'>:end_time</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_in_date'>in_date</span> <span class='op'>+</span> <span class='id identifier rubyid_repeat_count'>repeat_count</span><span class='op'>*</span><span class='const'>IceCube</span><span class='op'>::</span><span class='const'>ONE_WEEK</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_current_schedule'>current_schedule</span><span class='period'>.</span><span class='id identifier rubyid_add_recurrence_rule'>add_recurrence_rule</span> <span class='const'>Rule</span><span class='period'>.</span><span class='id identifier rubyid_weekly'>weekly</span>

    <span class='comment'>#Check for any possible collisions with non-recurring reservations
</span>    <span class='id identifier rubyid_conflicting_instances'>conflicting_instances</span><span class='op'>=</span><span class='id identifier rubyid_current_schedule'>current_schedule</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='lparen'>(</span><span class='id identifier rubyid_repeat_count'>repeat_count</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_conflicting_instances'>conflicting_instances</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_ct'>ct</span><span class='op'>|</span>

      <span class='id identifier rubyid_reservations'>reservations</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bookable_id = :bookable_id AND bookable_type = :bookable_type AND status &lt;&gt; :status AND ((:out_date &gt;= check_out_date AND  :out_date &lt;= check_in_date) OR (:in_date &lt;= check_in_date AND :in_date &gt;= check_out_date) OR (:out_date &lt;= check_in_date AND :in_date &gt;= check_in_date)) AND is_recurring= :is_recurring</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:bookable_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_id</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:bookable_type</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_type</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:status</span> <span class='op'>=&gt;</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_IN</span><span class='comma'>,</span> <span class='symbol'>:out_date</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ct'>ct</span><span class='comma'>,</span> <span class='symbol'>:in_date</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ct'>ct</span> <span class='op'>+</span> <span class='id identifier rubyid_current_schedule'>current_schedule</span><span class='period'>.</span><span class='id identifier rubyid_duration'>duration</span> <span class='comma'>,</span> <span class='symbol'>:is_recurring</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rparen'>)</span> 

      <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_reservations'>reservations</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
        <span class='ivar'>@error_message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This Recurring Reservation conflicts with another existing Non-Recurring Reservation</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>return</span>
      <span class='kw'>end</span>

    <span class='kw'>end</span>

    <span class='comment'>#Check for conflicts with another recurring reservation
</span>    <span class='id identifier rubyid_reservations'>reservations</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='symbol'>:all</span><span class='comma'>,</span> <span class='symbol'>:conditions</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bookable_id = ? AND bookable_type = ? AND check_out_date &lt;= ? AND status &lt;&gt; ? AND is_recurring = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_id</span><span class='rbracket'>]</span><span class='comma'>,</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_type</span><span class='rbracket'>]</span><span class='comma'>,</span><span class='id identifier rubyid_current_schedule'>current_schedule</span><span class='period'>.</span><span class='id identifier rubyid_end_time'>end_time</span><span class='comma'>,</span><span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_IN</span><span class='comma'>,</span><span class='kw'>true</span><span class='rbracket'>]</span>

    <span class='id identifier rubyid_reservations'>reservations</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span>

      <span class='id identifier rubyid_schedule'>schedule</span><span class='op'>=</span><span class='const'>Schedule</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_out_date'>check_out_date</span><span class='comma'>,</span><span class='lbrace'>{</span> <span class='symbol'>:duration</span> <span class='op'>=&gt;</span><span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_in_date'>check_in_date</span> <span class='op'>-</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_out_date'>check_out_date</span><span class='comma'>,</span> <span class='symbol'>:end_time</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_in_date'>check_in_date</span> <span class='op'>+</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_repeat_count'>repeat_count</span><span class='op'>*</span><span class='const'>IceCube</span><span class='op'>::</span><span class='const'>ONE_WEEK</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_schedule'>schedule</span><span class='period'>.</span><span class='id identifier rubyid_add_recurrence_rule'>add_recurrence_rule</span> <span class='const'>Rule</span><span class='period'>.</span><span class='id identifier rubyid_weekly'>weekly</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_schedule'>schedule</span><span class='period'>.</span><span class='id identifier rubyid_conflicts_with?'>conflicts_with?</span><span class='lparen'>(</span><span class='id identifier rubyid_current_schedule'>current_schedule</span><span class='rparen'>)</span> <span class='kw'>then</span>
        <span class='ivar'>@error_message</span> <span class='op'>=</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This Recurring Reservation conflicts with another recurring reservation,Contact the Administrator</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>return</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_reservation'>reservation</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_bookable_type'>bookable_type</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_type</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_bookable_id'>bookable_id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_id</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find_by_id'>find_by_id</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_id</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_check_in_date'>check_in_date</span> <span class='op'>=</span> <span class='id identifier rubyid_in_date'>in_date</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_check_out_date'>check_out_date</span> <span class='op'>=</span> <span class='id identifier rubyid_out_date'>out_date</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_READY</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_notes'>notes</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:notes</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_is_recurring'>is_recurring</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_repeat_count'>repeat_count</span> <span class='op'>=</span> <span class='id identifier rubyid_repeat_count'>repeat_count</span>
    <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_html'>html</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_js'>js</span>
  <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="delete-instance_method">
  
    - (<tt>Object</tt>) <strong>delete</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Deletes a Reservation from the DB.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'>
<p>Nothing.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


248
249
250
251
252
253</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/reservations_controller.rb', line 248</span>

<span class='kw'>def</span> <span class='id identifier rubyid_delete'>delete</span>
  <span class='id identifier rubyid_reservation'>reservation</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_find_by_id'>find_by_id</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span>
  <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='id identifier rubyid_x'>x</span> <span class='op'>==</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sort'>sort</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="find_bookable-instance_method">
  
    - (<tt>Object</tt>) <strong>find_bookable</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Finds out what type of class a bookable (polymorphic class) is</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'>
<p>A string representing the bookable type.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


322
323
324
325
326
327
328</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/reservations_controller.rb', line 322</span>

<span class='kw'>def</span> <span class='id identifier rubyid_find_bookable'>find_bookable</span>
  <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(.+)_id$</span><span class='regexp_end'>/</span></span>
      <span class='kw'>return</span> <span class='backref'>$1</span><span class='period'>.</span><span class='id identifier rubyid_classify'>classify</span><span class='period'>.</span><span class='id identifier rubyid_constantize'>constantize</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="history-instance_method">
  
    - (<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>) <strong>history</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Displays old reservations.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>array.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


294
295
296
297
298
299
300</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/reservations_controller.rb', line 294</span>

<span class='kw'>def</span> <span class='id identifier rubyid_history'>history</span>
  <span class='comment'>#@bookable = find_bookable
</span>  <span class='comment'>#@reservations = @bookable.reservations
</span>  <span class='ivar'>@reservations</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>status = ? AND is_recurring = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_IN</span><span class='comma'>,</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='ivar'>@reservations</span> <span class='op'>=</span> <span class='ivar'>@reservations</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_bookable'>bookable</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='rbrace'>}</span>
  <span class='ivar'>@recurring_reservations</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>status = ? AND is_recurring = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_IN</span><span class='comma'>,</span><span class='kw'>true</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="index-instance_method">
  
    - (<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>) <strong>index</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Lists all the Reservations from the DB.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>array.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/reservations_controller.rb', line 11</span>

<span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
  <span class='id identifier rubyid_fifteen_days_ago'>fifteen_days_ago</span> <span class='op'>=</span> <span class='const'>DateTime</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>-</span> <span class='int'>15</span>
  <span class='id identifier rubyid_next_fifteen_days'>next_fifteen_days</span> <span class='op'>=</span> <span class='const'>DateTime</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='int'>15</span>
  <span class='ivar'>@reservations</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='symbol'>:all</span><span class='comma'>,</span> <span class='symbol'>:conditions</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>status &lt;&gt; '</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_IN</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>' AND (check_in_date BETWEEN ? AND ? OR check_out_date BETWEEN ? AND ?) AND is_recurring = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_fifteen_days_ago'>fifteen_days_ago</span><span class='comma'>,</span> <span class='id identifier rubyid_next_fifteen_days'>next_fifteen_days</span><span class='comma'>,</span> <span class='id identifier rubyid_fifteen_days_ago'>fifteen_days_ago</span><span class='comma'>,</span> <span class='id identifier rubyid_next_fifteen_days'>next_fifteen_days</span><span class='comma'>,</span><span class='kw'>false</span><span class='rbracket'>]</span>
  <span class='ivar'>@recurring_reservations</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='symbol'>:all</span><span class='comma'>,</span> <span class='symbol'>:conditions</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>status &lt;&gt; ? AND is_recurring = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_IN</span><span class='comma'>,</span><span class='kw'>true</span><span class='rbracket'>]</span>
  <span class='ivar'>@reservations</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_out_date'>check_out_date</span>  <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>!=</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_OUT</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_MISSING_PICKUP_DATE</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_in_date'>check_in_date</span>
      <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_MISSING_RETURN_DATE</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
  <span class='kw'>end</span>

  <span class='ivar'>@recurring_reservations</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_out_date'>check_out_date</span>  <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>!=</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_OUT</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_MISSING_PICKUP_DATE</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_in_date'>check_in_date</span> <span class='op'>+</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_repeat_count'>repeat_count</span><span class='op'>*</span><span class='const'>IceCube</span><span class='op'>::</span><span class='const'>ONE_WEEK</span>
      <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_MISSING_RETURN_DATE</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
  <span class='kw'>end</span>

  <span class='ivar'>@reservations</span> <span class='op'>=</span> <span class='ivar'>@reservations</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_bookable'>bookable</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='rbrace'>}</span>
  <span class='ivar'>@recurring_reservations</span> <span class='op'>=</span> <span class='ivar'>@recurring_reservations</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_bookable'>bookable</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="live_search-instance_method">
  
    - (<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>) <strong>live_search</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Searches reservations via ajax.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>array.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/reservations_controller.rb', line 258</span>

<span class='kw'>def</span> <span class='id identifier rubyid_live_search'>live_search</span>

  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>HTTP_REFERER</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>history</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span>
    <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='symbol'>:all</span><span class='comma'>,</span> <span class='symbol'>:conditions</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>status &lt;&gt; '</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_IN</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>'</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='symbol'>:all</span><span class='comma'>,</span> <span class='symbol'>:conditions</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>status = '</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_IN</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>'</span><span class='tstring_end'>&quot;</span></span>      
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:asset_name</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='op'>!</span><span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_bookable'>bookable</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:asset_name</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:own</span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='kw'>nil</span>
    <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='op'>!=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='rbrace'>}</span>     
  <span class='kw'>else</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_firstname</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='op'>!</span><span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_firstname'>firstname</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_firstname</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_lastname</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='op'>!</span><span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_lastname'>lastname</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_lastname</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_email</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='op'>!</span><span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_mail'>mail</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_email</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:days</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_days_ago'>days_ago</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='const'>DateTime</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>-</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:days</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_days_from_now'>days_from_now</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='const'>DateTime</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:days</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='lparen'>(</span><span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_check_out_date'>check_out_date</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_days_ago'>days_ago</span> <span class='op'>||</span> <span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_check_out_date'>check_out_date</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_days_from_now'>days_from_now</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_check_in_date'>check_in_date</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_days_ago'>days_ago</span> <span class='op'>||</span> <span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_check_in_date'>check_in_date</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_days_from_now'>days_from_now</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:criteria</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ASSET_NAME</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:direction</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DESC</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sort'>sort</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="new-instance_method">
  
    - (<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>) <strong>new</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Creates a new Reservation instance, ready to be written to the DB.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


43
44
45
46
47
48
49
50
51
52</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/reservations_controller.rb', line 43</span>

<span class='kw'>def</span> <span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@object_type</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:object_type</span><span class='rbracket'>]</span>
  <span class='kw'>if</span> <span class='ivar'>@object_type</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Asset</span><span class='tstring_end'>&quot;</span></span>
    <span class='ivar'>@object</span> <span class='op'>=</span> <span class='const'>Asset</span><span class='period'>.</span><span class='id identifier rubyid_find_by_id'>find_by_id</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span>
  <span class='kw'>else</span>
    <span class='ivar'>@object</span> <span class='op'>=</span> <span class='const'>AssetGroup</span><span class='period'>.</span><span class='id identifier rubyid_find_by_id'>find_by_id</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
  <span class='ivar'>@users</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:all</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_render'>render</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>new</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:layout</span><span class='op'>=&gt;</span><span class='kw'>false</span>  
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="show_by_bookable-instance_method">
  
    - (<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>) <strong>show_by_bookable</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Search reservations by the polymorphic bookable class.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


191
192
193
194
195
196</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/reservations_controller.rb', line 191</span>

<span class='kw'>def</span> <span class='id identifier rubyid_show_by_bookable'>show_by_bookable</span>
  <span class='ivar'>@reservations</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='symbol'>:all</span><span class='comma'>,</span> <span class='symbol'>:conditions</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bookable_id = '</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_id</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>' AND bookable_type = '</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:bookable_type</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>' AND status &lt;&gt; '</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>Reservation</span><span class='op'>::</span><span class='const'>STATUS_CHECKED_IN</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>'</span><span class='tstring_end'>&quot;</span></span>
  <span class='ivar'>@criteria</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>ASSET_NAME</span><span class='tstring_end'>'</span></span>
  <span class='ivar'>@direction</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>DESC</span><span class='tstring_end'>'</span></span>
  <span class='id identifier rubyid_render'>render</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>show_by_bookable</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:layout</span> <span class='op'>=&gt;</span> <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="show_notes-instance_method">
  
    - (<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>) <strong>show_notes</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Displays any notes added to a given reservation.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


305
306
307
308</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/reservations_controller.rb', line 305</span>

<span class='kw'>def</span> <span class='id identifier rubyid_show_notes'>show_notes</span>
  <span class='id identifier rubyid_reservation'>reservation</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:partial</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>show_notes</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:layout</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='symbol'>:locals</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:reservation</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_reservation'>reservation</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="sort-instance_method">
  
    - (<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>) <strong>sort</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Sorts a resultset of reservations.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Reservation.html" title="Reservation (class)">Reservation</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>array.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/reservations_controller.rb', line 201</span>

<span class='kw'>def</span> <span class='id identifier rubyid_sort'>sort</span>
  <span class='id identifier rubyid_resultset'>resultset</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:resultset</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_criteria'>criteria</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:criteria</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_direction'>direction</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:direction</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_reservations'>reservations</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_resultset'>resultset</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_criteria'>criteria</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>ASSET_NAME</span><span class='tstring_end'>'</span></span>
    <span class='id identifier rubyid_reservations'>reservations</span> <span class='op'>=</span> <span class='id identifier rubyid_reservations'>reservations</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_bookable'>bookable</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='rbrace'>}</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_criteria'>criteria</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>USER_NAME</span><span class='tstring_end'>'</span></span>
    <span class='id identifier rubyid_reservations'>reservations</span> <span class='op'>=</span> <span class='id identifier rubyid_reservations'>reservations</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_firstname'>firstname</span> <span class='rbrace'>}</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_criteria'>criteria</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>CHECK_OUT_DATE</span><span class='tstring_end'>'</span></span>
    <span class='id identifier rubyid_reservations'>reservations</span> <span class='op'>=</span> <span class='id identifier rubyid_reservations'>reservations</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_out_date'>check_out_date</span> <span class='rbrace'>}</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_criteria'>criteria</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>CHECK_IN_DATE</span><span class='tstring_end'>'</span></span>
    <span class='id identifier rubyid_reservations'>reservations</span> <span class='op'>=</span> <span class='id identifier rubyid_reservations'>reservations</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_check_in_date'>check_in_date</span> <span class='rbrace'>}</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_criteria'>criteria</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>STATUS</span><span class='tstring_end'>'</span></span>
    <span class='id identifier rubyid_reservations'>reservations</span> <span class='op'>=</span> <span class='id identifier rubyid_reservations'>reservations</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_r'>r</span><span class='op'>|</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_direction'>direction</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>ASC</span><span class='tstring_end'>'</span></span>
    <span class='id identifier rubyid_reservations'>reservations</span> <span class='op'>=</span> <span class='id identifier rubyid_reservations'>reservations</span><span class='period'>.</span><span class='id identifier rubyid_reverse'>reverse</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:origin</span><span class='rbracket'>]</span><span class='op'>==</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>NON_RECURRING</span><span class='tstring_end'>'</span></span>
    <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:partial</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sorted_list_of_reservations</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:layout</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='symbol'>:locals</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:reservations</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_reservations'>reservations</span><span class='comma'>,</span> <span class='symbol'>:criteria</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_criteria'>criteria</span><span class='comma'>,</span> <span class='symbol'>:direction</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_direction'>direction</span> <span class='rbrace'>}</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:partial</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sorted_list_of_recurring_reservations</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:layout</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='symbol'>:locals</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:reservations</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_reservations'>reservations</span><span class='comma'>,</span> <span class='symbol'>:criteria</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_criteria'>criteria</span><span class='comma'>,</span> <span class='symbol'>:direction</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_direction'>direction</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_notes-instance_method">
  
    - (<tt>Object</tt>) <strong>update_notes</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Updates any notes added to a given Reservation.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'>
<p>Nothing.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


313
314
315
316
317</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/reservations_controller.rb', line 313</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_notes'>update_notes</span>
  <span class='id identifier rubyid_reservation'>reservation</span> <span class='op'>=</span> <span class='const'>Reservation</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_notes'>notes</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:notes</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_reservation'>reservation</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Sun Aug 19 20:10:22 2012 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.2.1 (ruby-1.9.3).
</div>

  </body>
</html>